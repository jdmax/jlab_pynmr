

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>app.daq &mdash; JLab PyNMR 0.2 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> JLab PyNMR
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">JLab PyNMR</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>app.daq</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for app.daq</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;PyNMR, J.Maxwell 2020</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">telnetlib</span>
<span class="kn">import</span> <span class="nn">unyt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">nidaqmx</span>
<span class="kn">from</span> <span class="nn">nidaqmx.constants</span> <span class="k">import</span> <span class="p">(</span><span class="n">DigitalWidthUnits</span><span class="p">,</span> <span class="n">AcquisitionType</span><span class="p">,</span>
                               <span class="n">ReadRelativeTo</span><span class="p">,</span> <span class="n">OverwriteMode</span><span class="p">,</span> <span class="n">DigitalWidthUnits</span><span class="p">,</span>
                               <span class="n">TriggerType</span><span class="p">,</span> <span class="n">TaskMode</span><span class="p">,</span> <span class="n">READ_ALL_AVAILABLE</span><span class="p">)</span>
                               
<div class="viewcode-block" id="DAQConnection"><a class="viewcode-back" href="../../source/app.html#app.daq.DAQConnection">[docs]</a><span class="k">class</span> <span class="nc">DAQConnection</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Handle connection to and communication with DAQ system. Designed to hide all the specifics of different DAQ systems with generic actions for all. Init will open connections and send configuration settings to DAQ.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        config: Config object with settings</span>
<span class="sd">        timeout: Timeout for DAQ system</span>
<span class="sd">        tune_mode: Use tune mode, with only one chuck</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">tune_mode</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">daq_type</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;daq_type&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tune_mode</span> <span class="o">=</span> <span class="n">tune_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">daq_type</span><span class="o">==</span><span class="s1">&#39;FPGA&#39;</span><span class="p">:</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">udp</span> <span class="o">=</span> <span class="n">UDP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcp</span> <span class="o">=</span> <span class="n">TCP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error creating socket:&quot;</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Address related error connecting:&quot;</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">udp</span><span class="o">.</span><span class="n">ip</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Connected to: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">udp</span><span class="o">.</span><span class="n">ip</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, port &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">udp</span><span class="o">.</span><span class="n">port</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, and set registers and frequency table.&#39;</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">daq_type</span><span class="o">==</span><span class="s1">&#39;NIDAQ&#39;</span><span class="p">:</span>          
            <span class="k">with</span> <span class="n">nidaqmx</span><span class="o">.</span><span class="n">Task</span><span class="p">()</span> <span class="k">as</span> <span class="n">ai</span><span class="p">,</span> <span class="n">nidaqmx</span><span class="o">.</span><span class="n">Task</span><span class="p">()</span> <span class="k">as</span> <span class="n">ao</span><span class="p">:</span>
                <span class="n">setup_chans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">ai</span><span class="p">,</span><span class="n">ao</span><span class="p">)</span>  <span class="c1"># test setup of nidaq            </span>
            
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">daq_type</span><span class="o">==</span><span class="s1">&#39;Test&#39;</span><span class="p">:</span>          
            <span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_phase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_diode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;app/test_data.txt&quot;</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>               
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;DAQ Test mode.&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Test&#39;</span>


    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Stop Connections&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">daq_type</span><span class="o">==</span><span class="s1">&#39;FPGA&#39;</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">udp</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcp</span>

<div class="viewcode-block" id="DAQConnection.start_sweeps"><a class="viewcode-back" href="../../source/app.html#app.daq.DAQConnection.start_sweeps">[docs]</a>    <span class="k">def</span> <span class="nf">start_sweeps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Send command to sending NMR sweeps&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">daq_type</span><span class="o">==</span><span class="s1">&#39;FPGA&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">udp</span><span class="o">.</span><span class="n">act_sweep</span><span class="p">()</span></div>

<div class="viewcode-block" id="DAQConnection.get_chunk"><a class="viewcode-back" href="../../source/app.html#app.daq.DAQConnection.get_chunk">[docs]</a>    <span class="k">def</span> <span class="nf">get_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Receive subset of total sweeps for the event&#39;&#39;&#39;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">daq_type</span><span class="o">==</span><span class="s1">&#39;FPGA&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcp</span><span class="o">.</span><span class="n">get_chunk</span><span class="p">()</span>   
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">daq_type</span><span class="o">==</span><span class="s1">&#39;NIDAQ&#39;</span><span class="p">:</span>          
            <span class="k">with</span> <span class="n">nidaqmx</span><span class="o">.</span><span class="n">Task</span><span class="p">()</span> <span class="k">as</span> <span class="n">ai</span><span class="p">,</span> <span class="n">nidaqmx</span><span class="o">.</span><span class="n">Task</span><span class="p">()</span> <span class="k">as</span> <span class="n">ao</span><span class="p">:</span>
                <span class="n">setup_chans</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">ao</span><span class="p">)</span>  <span class="c1"># setup of nidaq  </span>
                <span class="n">start</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">ao</span><span class="p">)</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">samples</span> <span class="o">=</span> <span class="n">ai</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">READ_ALL_AVAILABLE</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">pretri_delay_s</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">cutandavg</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">pts_per_tri</span><span class="p">))</span>
            
            
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">daq_type</span><span class="o">==</span><span class="s1">&#39;Test&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune_mode</span><span class="p">:</span>
                <span class="n">num_in_chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tune_per_chunk&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_in_chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;num_per_chunk&#39;</span><span class="p">]</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.0005</span><span class="o">*</span><span class="n">num_in_chunk</span><span class="p">)</span>
            
            <span class="n">p_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_phase</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_phase</span><span class="p">))</span><span class="o">*</span><span class="mf">0.00001</span><span class="o">*</span><span class="n">num_in_chunk</span>   <span class="c1"># numpy arrays</span>
            <span class="n">d_test</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">test_diode</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_diode</span><span class="p">))</span><span class="o">*</span><span class="mf">0.00001</span><span class="o">*</span><span class="n">num_in_chunk</span> 
            <span class="k">return</span> <span class="p">(</span><span class="n">num_in_chunk</span><span class="p">,</span> <span class="n">p_test</span><span class="p">,</span> <span class="n">d_test</span><span class="p">)</span></div></div>
      
<div class="viewcode-block" id="UDP"><a class="viewcode-back" href="../../source/app.html#app.daq.UDP">[docs]</a><span class="k">class</span> <span class="nc">UDP</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Handle UDP commands and responses</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        config: Config object with settings</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Start connection, send nmr_settings dict&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ok</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">&#39;0300FA&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;fpga_settings&#39;</span><span class="p">][</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;fpga_settings&#39;</span><span class="p">][</span><span class="s1">&#39;port&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_register</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Set register error&quot;</span><span class="p">)</span>
        <span class="c1">#print(self.read_stat())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_freq</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">freq_bytes</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Set frequency error&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_freq</span><span class="p">()</span>
        
        
    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Stop connection&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
<div class="viewcode-block" id="UDP.read_stat"><a class="viewcode-back" href="../../source/app.html#app.daq.UDP.read_stat">[docs]</a>    <span class="k">def</span> <span class="nf">read_stat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Read status command</span>
<span class="sd">        Returns:</span>
<span class="sd">            Data sent back as hex</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">&#39;0F0001000000000000000000000000&#39;</span><span class="p">))</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="c1">#print(&quot;Read Stat Message: &quot;, data.hex())</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="UDP.read_freq"><a class="viewcode-back" href="../../source/app.html#app.daq.UDP.read_freq">[docs]</a>    <span class="k">def</span> <span class="nf">read_freq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Read frequency command</span>
<span class="sd">        Returns:</span>
<span class="sd">            Data sent back as hex</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">&#39;0F0003000000000000000000000000&#39;</span><span class="p">))</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">1028</span><span class="p">)</span>   <span class="c1"># buffer size is 1027 to get all of the points</span>
        <span class="c1">#print(&quot;Read Freq Message: &quot;, data.hex())</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="UDP.set_register"><a class="viewcode-back" href="../../source/app.html#app.daq.UDP.set_register">[docs]</a>    <span class="k">def</span> <span class="nf">set_register</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Send set register command and string</span>
<span class="sd">        Returns:</span>
<span class="sd">            Boolean denoting success</span>
<span class="sd">            &#39;&#39;&#39;</span>
            
        <span class="c1"># Make ADC Config int from list of bools</span>
        <span class="n">test_mode</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">phase_drate1</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">phase_drate0</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">phase_fpath</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">diode_drate1</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">diode_drate0</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">diode_fpath</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="n">test_mode</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">phase_drate1</span><span class="p">,</span> <span class="n">phase_drate0</span><span class="p">,</span> <span class="n">phase_fpath</span><span class="p">,</span> <span class="n">diode_drate1</span><span class="p">,</span> <span class="n">diode_drate0</span><span class="p">,</span> <span class="n">diode_fpath</span><span class="p">]</span>
        <span class="n">adcbits</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">states</span><span class="p">])</span>
        <span class="n">ADCConfig</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">adcbits</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            
        <span class="c1"># Make Resiter byte string from other inputs</span>
        <span class="c1"># Number Bytes LSB, Nymber Bytes MSB, LSByte GenSetTime, MSByte GenSetTime, LSByte NumOfSamToAve, MByte NumOfSamToAve, LSByte TotSweepCycle, MSByte TotSweepCycle, LSByte IntSweepCycle, MSByte IntSweepCycle, LSByte AdcConfig, MSByte AdcConfig</span>
        <span class="n">RegSets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">&#39;0F00&#39;</span><span class="p">),</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">&#39;02&#39;</span><span class="p">)]</span>
        <span class="n">RegSets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;fpga_settings&#39;</span><span class="p">][</span><span class="s1">&#39;dwell&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;little&#39;</span><span class="p">))</span>
        <span class="n">RegSets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;fpga_settings&#39;</span><span class="p">][</span><span class="s1">&#39;per_point&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;little&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune_mode</span><span class="p">:</span>
            <span class="n">RegSets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tune_per_chunk&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;little&#39;</span><span class="p">))</span>
            <span class="n">RegSets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tune_per_chunk&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;little&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">RegSets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">controls</span><span class="p">[</span><span class="s1">&#39;sweeps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;little&#39;</span><span class="p">))</span>
            <span class="n">RegSets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;num_per_chunk&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;little&#39;</span><span class="p">))</span>
        <span class="n">RegSets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ADCConfig</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;little&#39;</span><span class="p">))</span>
        <span class="n">RegSets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">&#39;FF00&#39;</span><span class="p">))</span>
        <span class="n">RegSetString</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RegSets</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">RegSetString</span><span class="p">)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>    <span class="c1"># buffer size is 1024</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>
    
<div class="viewcode-block" id="UDP.set_freq"><a class="viewcode-back" href="../../source/app.html#app.daq.UDP.set_freq">[docs]</a>    <span class="k">def</span> <span class="nf">set_freq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq_bytes</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Send frequency points, converts freq list into bytes</span>
<span class="sd">        Args:</span>
<span class="sd">            freq_bytes: List of bytes for R&amp;S frequency modulation</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Boolean denoting success</span>
<span class="sd">        &#39;&#39;&#39;</span>
      
        <span class="n">NumBytes_byte</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;little&#39;</span><span class="p">)</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">NumBytes_byte</span> <span class="o">+</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">&#39;04&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">freq_bytes</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;fpga_settings&#39;</span><span class="p">][</span><span class="s1">&#39;test_freqs&#39;</span><span class="p">]:</span>
            <span class="n">NumBytes_byte</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;little&#39;</span><span class="p">)</span>
            <span class="n">FreqList</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">FreqBytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;little&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">FreqList</span><span class="p">]</span>
            <span class="n">TestTable</span> <span class="o">=</span> <span class="n">NumBytes_byte</span> <span class="o">+</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">&#39;04&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FreqBytes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">TestTable</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>    <span class="c1"># buffer size is 1024</span>
        <span class="c1">#print(&quot;Set Freq Message: &quot;, data.hex())</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>
        
<div class="viewcode-block" id="UDP.act_sweep"><a class="viewcode-back" href="../../source/app.html#app.daq.UDP.act_sweep">[docs]</a>    <span class="k">def</span> <span class="nf">act_sweep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Send activate sweep command</span>
<span class="sd">        Returns:</span>
<span class="sd">            Boolean denoting success</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">&#39;0F0005000000000000000000000000&#39;</span><span class="p">))</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>    <span class="c1"># buffer size is 1024</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="UDP.int_sweep"><a class="viewcode-back" href="../../source/app.html#app.daq.UDP.int_sweep">[docs]</a>    <span class="k">def</span> <span class="nf">int_sweep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Send interrupt sweep command</span>
<span class="sd">        Returns:</span>
<span class="sd">            Boolean denoting success</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">&#39;0F0006000000000000000000000000&#39;</span><span class="p">))</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>    <span class="c1"># buffer size is 1024</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>
    
<div class="viewcode-block" id="TCP"><a class="viewcode-back" href="../../source/app.html#app.daq.TCP">[docs]</a><span class="k">class</span> <span class="nc">TCP</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Handle TCP commands and responses</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        config: Config object with settings</span>
<span class="sd">        timeout: Int for TCP timeout time (secs)</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">timeout</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Start connection&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;fpga_settings&#39;</span><span class="p">][</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;fpga_settings&#39;</span><span class="p">][</span><span class="s1">&#39;port&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;fpga_settings&#39;</span><span class="p">][</span><span class="s1">&#39;tcp_buffer&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Stop connection&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
<div class="viewcode-block" id="TCP.get_chunk"><a class="viewcode-back" href="../../source/app.html#app.daq.TCP.get_chunk">[docs]</a>    <span class="k">def</span> <span class="nf">get_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Receive chunks over tcp</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Number of sweeps in chunk, phase chunk and diode chunk numpy arrays</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">num_in_chunk</span> <span class="o">=</span> <span class="mi">0</span>              <span class="c1">#  Number of sweeps in the chunk</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
        <span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;diode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
        <span class="n">sweep_type</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>    <span class="c1"># phase or diode, starts as &#39;&#39;</span>
        
        <span class="k">while</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">])</span><span class="o">==</span><span class="mi">512</span><span class="o">*</span><span class="mi">5</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;diode&#39;</span><span class="p">])</span><span class="o">==</span><span class="mi">512</span><span class="o">*</span><span class="mi">5</span><span class="p">):</span>       <span class="c1"># loop for chunk packets</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sweep_type</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>   <span class="c1"># first packet has 3 init bytes: 2 for chucks sw cyc, 1 for aa, bb</span>
                <span class="n">num_in_chunk</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">response</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span><span class="s1">&#39;little&#39;</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
                <span class="n">sweep_type</span> <span class="o">=</span> <span class="s1">&#39;phase&#39;</span>
                       
            <span class="n">res_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">response</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">))]</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">res_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sweep_type</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="c1">#print(&quot;no type: &quot;,b)</span>
                    <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xbb</span><span class="s1">&#39;</span><span class="p">:</span>
                        <span class="n">sweep_type</span> <span class="o">=</span> <span class="s1">&#39;diode&#39;</span>
                    <span class="k">continue</span>
                <span class="c1">#if sweep_type == &#39;diode&#39;: print(b.hex())</span>
                <span class="n">chunk</span><span class="p">[</span><span class="n">sweep_type</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="n">sweep_type</span><span class="p">])</span> <span class="o">==</span> <span class="mi">512</span><span class="o">*</span><span class="mi">5</span><span class="p">):</span>             <span class="c1"># filled up chunk</span>
                    <span class="n">sweep_type</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>                   <span class="c1"># unset type</span>
                    
        <span class="n">pchunk_byte_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">]),</span> <span class="mi">5</span><span class="p">)]</span>
        <span class="n">dchunk_byte_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;diode&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;diode&#39;</span><span class="p">]),</span> <span class="mi">5</span><span class="p">)]</span>
        <span class="n">pchunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(((</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;little&#39;</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">num_in_chunk</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pchunk_byte_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>   <span class="c1"># average (number of sweeps times two for up and down) and put in numpy array</span>
        <span class="n">dchunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(((</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;little&#39;</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">num_in_chunk</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dchunk_byte_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                        
        <span class="k">return</span> <span class="p">(</span><span class="n">num_in_chunk</span><span class="p">,</span> <span class="n">pchunk</span><span class="p">,</span> <span class="n">dchunk</span><span class="p">)</span></div></div>
        
<div class="viewcode-block" id="RS_Connection"><a class="viewcode-back" href="../../source/app.html#app.daq.RS_Connection">[docs]</a><span class="k">class</span> <span class="nc">RS_Connection</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Handle connection to Rohde and Schwarz SMA100A via Telnet. </span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        config: Current Config object</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>        
        <span class="sd">&#39;&#39;&#39;Open connection to R&amp;S, send commands for all settings, and read all back to check. Close.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;RS_settings&#39;</span><span class="p">][</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="mi">5025</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tn</span> <span class="o">=</span> <span class="n">telnetlib</span><span class="o">.</span><span class="n">Telnet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;RS_settings&#39;</span><span class="p">][</span><span class="s1">&#39;timeout&#39;</span><span class="p">])</span>
            
            <span class="c1"># Write all required settings</span>
            
            <span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;FREQ {config.channel[&#39;cent_freq&#39;]*1000000}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39;ascii&#39;</span><span class="p">))</span>
            <span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;POWer </span><span class="si">{config.channel[&#39;power&#39;]}</span><span class="s2"> mV</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39;ascii&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;FPGA&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;daq_type&#39;</span><span class="p">]:</span>
                <span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;FM:SOUR EDIG</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;NIDAQ&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;daq_type&#39;</span><span class="p">]:</span>
                <span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;FM:SOUR EXT</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;FM:SOUR EXT</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>  
            <span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;FM:EXT:DEV {config.channel[&#39;mod_freq&#39;]*1000}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39;ascii&#39;</span><span class="p">))</span>
            <span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;FM:EXT:DIG:BFOR BOFF</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;FM:STATE ON</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;OUTP ON</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;FREQ?</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="n">tn</span><span class="o">.</span><span class="n">read_some</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;POW?</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">pow</span> <span class="o">=</span> <span class="n">tn</span><span class="o">.</span><span class="n">read_some</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;FM:SOUR?</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sour</span> <span class="o">=</span> <span class="n">tn</span><span class="o">.</span><span class="n">read_some</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;FM:EXT:DEV?</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">dev</span> <span class="o">=</span> <span class="n">tn</span><span class="o">.</span><span class="n">read_some</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;FM:EXT:DIG:BFOR?</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">bfor</span> <span class="o">=</span> <span class="n">tn</span><span class="o">.</span><span class="n">read_some</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;FM:STATE?</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fmstate</span> <span class="o">=</span> <span class="n">tn</span><span class="o">.</span><span class="n">read_some</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;OUTP?</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">outp</span> <span class="o">=</span> <span class="n">tn</span><span class="o">.</span><span class="n">read_some</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
            
            <span class="n">tn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Telnet connection failed:&quot;</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
        
<div class="viewcode-block" id="RS_Connection.rf_off"><a class="viewcode-back" href="../../source/app.html#app.daq.RS_Connection.rf_off">[docs]</a>    <span class="k">def</span> <span class="nf">rf_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Connect to turn off RF, then close.&#39;&#39;&#39;</span>        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tn</span> <span class="o">=</span> <span class="n">telnetlib</span><span class="o">.</span><span class="n">Telnet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
            <span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;FM:STATE OFF</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Telnet connection failed:&quot;</span><span class="p">,</span><span class="n">e</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="RS_Connection.rf_on"><a class="viewcode-back" href="../../source/app.html#app.daq.RS_Connection.rf_on">[docs]</a>    <span class="k">def</span> <span class="nf">rf_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Connect to turn on RF, then close.&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tn</span> <span class="o">=</span> <span class="n">telnetlib</span><span class="o">.</span><span class="n">Telnet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
            <span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;FM:STATE ON</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Telnet connection failed:&quot;</span><span class="p">,</span><span class="n">e</span><span class="p">)</span></div></div>
        
        
        
        
<div class="viewcode-block" id="NI_Connection"><a class="viewcode-back" href="../../source/app.html#app.daq.NI_Connection">[docs]</a><span class="k">class</span> <span class="nc">NI_Connection</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;NI DAQ in and out tasks and methods to use them. Code from C.Carlin.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        config: Current Config object</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">ai</span> <span class="o">=</span> <span class="n">nidaqmx</span><span class="o">.</span><span class="n">Task</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ao</span> <span class="o">=</span> <span class="n">nidaqmx</span><span class="o">.</span><span class="n">Task</span><span class="p">()</span>
    
        <span class="n">ramp_min_V</span><span class="p">,</span><span class="n">ramp_max_V</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">unyt</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">unyt</span><span class="o">.</span><span class="n">V</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pts_per_ramp</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretris</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nidaq_settings&#39;</span><span class="p">][</span><span class="s1">&#39;pretris&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tris_per_scan</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">controls</span><span class="p">[</span><span class="s1">&#39;sweeps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">time_per_pt_us</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nidaq_settings&#39;</span><span class="p">][</span><span class="s1">&#39;time_per_pt&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">unyt</span><span class="o">.</span><span class="n">us</span>
        <span class="n">settling_delay_ratio</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nidaq_settings&#39;</span><span class="p">][</span><span class="s1">&#39;settling_ratio&#39;</span><span class="p">]</span>
        <span class="n">ai_min_V</span><span class="p">,</span><span class="n">ai_max_V</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">unyt</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">unyt</span><span class="o">.</span><span class="n">V</span>

        <span class="n">phase_chan</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nidaq_settings&#39;</span><span class="p">][</span><span class="s1">&#39;phase_chan&#39;</span><span class="p">]</span>
        <span class="n">diode_chan</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nidaq_settings&#39;</span><span class="p">][</span><span class="s1">&#39;diode_chan&#39;</span><span class="p">]</span>
        <span class="n">ao_chan</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nidaq_settings&#39;</span><span class="p">][</span><span class="s1">&#39;ao_chan&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pts_per_tri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pts_per_ramp</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pts_per_tri</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tris_per_scan</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretris</span><span class="p">)</span>
        <span class="n">sample_rate_Hz</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">time_per_pt_us</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">unyt</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
        <span class="n">settling_delay_us</span> <span class="o">=</span> <span class="n">time_per_pt_us</span> <span class="o">*</span> <span class="n">settling_delay_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretri_delay_s</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pretris</span> <span class="o">*</span> <span class="n">time_per_pt_us</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pts_per_tri</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">unyt</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ramp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ramp_min_V</span><span class="p">,</span> <span class="n">ramp_max_V</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pts_per_ramp</span><span class="p">)</span>  <span class="c1">#Generate the ramp points</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">control</span><span class="p">(</span><span class="n">TaskMode</span><span class="o">.</span><span class="n">TASK_UNRESERVE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">ao_channels</span><span class="o">.</span><span class="n">add_ao_voltage_chan</span><span class="p">(</span><span class="n">ao_chan</span><span class="p">,</span>
                                           <span class="n">min_val</span><span class="o">=</span><span class="n">ramp_min_V</span><span class="p">,</span>
                                           <span class="n">max_val</span><span class="o">=</span><span class="n">ramp_max_V</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">timing</span><span class="o">.</span><span class="n">cfg_samp_clk_timing</span><span class="p">(</span><span class="n">sample_rate_Hz</span><span class="p">,</span>
                                      <span class="n">sample_mode</span><span class="o">=</span><span class="n">AcquisitionType</span><span class="o">.</span><span class="n">CONTINUOUS</span><span class="p">,</span>
                                      <span class="n">samps_per_chan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pts_per_tri</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">triggers</span><span class="o">.</span><span class="n">start_trigger</span><span class="o">.</span><span class="n">trig_type</span> <span class="o">=</span> <span class="n">TriggerType</span><span class="o">.</span><span class="n">NONE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ao_start_terminal</span> <span class="o">=</span> <span class="n">ao</span><span class="o">.</span><span class="n">triggers</span><span class="o">.</span><span class="n">start_trigger</span><span class="o">.</span><span class="n">term</span>

        <span class="c1">#Setup AI channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="o">.</span><span class="n">ai_channels</span><span class="o">.</span><span class="n">add_ai_voltage_chan</span><span class="p">(</span><span class="n">phase_chan</span><span class="p">,</span> <span class="n">min_val</span><span class="o">=</span><span class="n">ai_min_V</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="n">ai_max_V</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="o">.</span><span class="n">ai_channels</span><span class="o">.</span><span class="n">add_ai_voltage_chan</span><span class="p">(</span><span class="n">diode_chan</span><span class="p">,</span> <span class="n">min_val</span><span class="o">=</span><span class="n">ai_min_V</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="n">ai_max_V</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="o">.</span><span class="n">timing</span><span class="o">.</span><span class="n">delay_from_samp_clk_delay</span> <span class="o">=</span> <span class="n">settling_delay_us</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">unyt</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="o">.</span><span class="n">timing</span><span class="o">.</span><span class="n">delay_from_samp_clk_delay_units</span> <span class="o">=</span> <span class="n">DigitalWidthUnits</span><span class="o">.</span><span class="n">SECONDS</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="o">.</span><span class="n">timing</span><span class="o">.</span><span class="n">cfg_samp_clk_timing</span><span class="p">(</span><span class="n">sample_rate_Hz</span><span class="p">,</span>
                                      <span class="n">sample_mode</span><span class="o">=</span><span class="n">AcquisitionType</span><span class="o">.</span><span class="n">CONTINUOUS</span><span class="p">,</span>
                                      <span class="n">samps_per_chan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">total_pts</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="o">.</span><span class="n">timing</span><span class="o">.</span><span class="n">read_all_avail_samp</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="o">.</span><span class="n">timing</span><span class="o">.</span><span class="n">relative_to</span> <span class="o">=</span> <span class="n">ReadRelativeTo</span><span class="o">.</span><span class="n">FIRST_SAMPLE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="o">.</span><span class="n">timing</span><span class="o">.</span><span class="n">over_write</span>  <span class="o">=</span> <span class="n">OverwriteMode</span><span class="o">.</span><span class="n">OVERWRITE_UNREAD_SAMPLES</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="o">.</span><span class="n">triggers</span><span class="o">.</span><span class="n">start_trigger</span><span class="o">.</span><span class="n">cfg_dig_edge_start_trig</span><span class="p">(</span><span class="n">ao_start_terminal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="o">.</span><span class="n">triggers</span><span class="o">.</span><span class="n">start_trigger</span><span class="o">.</span><span class="n">trig_type</span> <span class="o">=</span> <span class="n">TriggerType</span><span class="o">.</span><span class="n">DIGITAL_EDGE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="o">.</span><span class="n">triggers</span><span class="o">.</span><span class="n">start_trigger</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">pretri_delay_s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="o">.</span><span class="n">triggers</span><span class="o">.</span><span class="n">start_trigger</span><span class="o">.</span><span class="n">delay_units</span> <span class="o">=</span> <span class="n">DigitalWidthUnits</span><span class="o">.</span><span class="n">SECONDS</span>
        
<div class="viewcode-block" id="NI_Connection.start"><a class="viewcode-back" href="../../source/app.html#app.daq.NI_Connection.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ramp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="o">.</span><span class="n">in_stream</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="NI_Connection.get_chunk"><a class="viewcode-back" href="../../source/app.html#app.daq.NI_Connection.get_chunk">[docs]</a>    <span class="k">def</span> <span class="nf">get_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get sweeps from NI board, return number of sweeps in chunk, phase np.array, diode np.array</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">READ_ALL_AVAILABLE</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pretri_delay_s</span><span class="p">)</span>  <span class="c1"># list of lists</span>
        <span class="n">pchunks</span><span class="p">,</span> <span class="n">dchunks</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">samples</span><span class="p">)</span>              <span class="c1"># split into phase and diode</span>
        <span class="n">num_in_chunk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pchunks</span><span class="p">)</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">pts_per_ramp</span>
        <span class="n">pchunks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pchunks</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pts_per_ramp</span><span class="p">,</span> <span class="n">num_in_chunk</span><span class="p">)</span>  <span class="c1"># 2D array with steps number of rows</span>
        <span class="n">pchunks</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">pchunks</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># flip every other column</span>
        <span class="n">dchunks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dchunks</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pts_per_ramp</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dchunks</span><span class="p">)</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">pts_per_ramp</span><span class="p">)</span>
        <span class="n">dchunks</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">dchunks</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># flip every other column</span>
        
        <span class="n">pchunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">pchunks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dchunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">dchunks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num_in_chunk</span><span class="p">,</span> <span class="n">pchunk</span><span class="p">,</span> <span class="n">dchunk</span></div></div>

     
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, James Maxwell

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>